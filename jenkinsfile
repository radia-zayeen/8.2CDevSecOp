pipeline {
    agent any

    environment {
        RECIPIENT = 'radia.zayeen@gmail.com'
    }

    stages {
        stage("Checkout") {
            steps {
                git branch: 'main', url: 'https://github.com/radia-zayeen/8.2CDevSecOp.git'
            }
        }

        stage("Install Dependencies") {
            steps {
                sh 'npm install'
            }
        }

        stage("Run Tests") {
            steps {
                sh 'npm test | tee test.log'
            }
            post {
                always {
                    script {
                        def testFailed = sh(script: "grep -q 'failing' test.log", returnStatus: true) == 0
                        def subject = testFailed ? "❌ Build Notification: Test Stage - FAILURE" : "✅ Build Notification: Test Stage - SUCCESS"
                        def body = testFailed ? "❌ The test stage failed. See attached log." : "✅ The test stage passed. See attached log."

                        emailext(
                            to: RECIPIENT,
                            subject: subject,
                            body: body,
                            attachmentsPattern: 'test.log',
                            attachLog: true
                        )

                        if (testFailed) {
                            error("Tests failed")
                        }
                    }
                }
            }
        }

        stage("Generate Coverage Report") {
            steps {
                sh 'npm run coverage || true'
            }
        }

        stage("NPM Audit (Security Scan)") {
            steps {
                sh 'npm audit | tee audit.log'
            }
            post {
                always {
                    script {
                        def issuesFound = sh(script: "grep -q 'found' audit.log", returnStatus: true) == 0
                        def subject = issuesFound ? "❌ Build Notification: Security Scan - FAILURE" : "✅ Build Notification: Security Scan - SUCCESS"
                        def body = issuesFound ? "❌ Security issues were found. See attached audit log." : "✅ Security scan passed."

                        emailext(
                            to: RECIPIENT,
                            subject: subject,
                            body: body,
                            attachmentsPattern: 'audit.log',
                            attachLog: true
                        )

                        if (issuesFound) {
                            error("Security scan failed")
                        }
                    }
                }
            }
        }
    }
}

